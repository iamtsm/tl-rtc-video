!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o,i=t();for(o in i)("object"==typeof exports?exports:e)[o]=i[o]}}(this,function(){return i={},r.m=o={"../../res/js/index.js":
/*!********************************************!*\
  !*** E:/code/tl-rtc-video/res/js/index.js ***!
  \********************************************/
/*! no static exports found */function(e,t){axios.get("/api/comm/initData",{}).then(e=>{let t=e.data;new Vue({el:"#clientApp",data:function(){let e=null;return io&&(e=io(t.wsHost)),{socket:e,socketId:0,config:t.rtcConfig,options:t.options,userMediaConfig:{audio:{echoCancellation:!0},video:!0},expand:{bindwidth:{timestampPrev:0,bytesPrev:0,bitrate:0},cssFilter:{cssFilterChoose:"none",cssFilterList:[{name:"无",value:"none"},{name:"模糊",value:"blur"},{name:"灰色",value:"grayscale"},{name:"反色",value:"invert"},{name:"棕褐色",value:"sepia"}]},videoTape:{errorMsg:"",videoText:"开始录像",recordedBlobs:[],mediaRecorder:new Object,sourceBuffer:new Object,mediaSource:new MediaSource}},createDisabled:!1,exitDisabled:!0,createClass:"layui-btn layui-btn-normal layui-btn-radius",exitClass:"layui-btn layui-btn-danger layui-btn-radius",disableClass:" layui-btn-disabled",showTools:0,messageSendTo:"",messageContent:"",roomId:10086,recoderId:0,rtcConns:{},remoteVideoList:[],remoteVideoMap:{},localStream:null}},methods:{createRoom:function(){this.roomId&&(this.socket.emit("createAndJoin",{room:this.roomId}),this.createDisabled=!0,this.exitDisabled=!1)},exitRoom:function(){for(var t in this.roomId&&this.socket.emit("exit",{from:this.socketId,room:this.roomId,recoderId:this.recoderId}),this.rtcConns){let e=this.rtcConns[t];e.close(),e=null}this.resetData()},resetData:function(){this.createDisabled=!1,this.exitDisabled=!0,this.createClass="layui-btn layui-btn-normal layui-btn-radius",this.exitClass="layui-btn layui-btn-danger layui-btn-radius",this.disableClass=" layui-btn-disabled",this.showTools=0,this.roomId=1,this.recoderId=0,this.rtcConns={},this.remoteVideoList=[],this.remoteVideoMap={},this.localStream=null},getRtcConnect:function(e){return this.rtcConns[e]},createRtcConnect:function(t){let o=this,i=new RTCPeerConnection(this.config);return i.onicecandidate=e=>{o.iceCandidate(i,t,e)},i.ontrack=e=>{o.trackStream(i,t,e)},null!=o.localStream&&o.localStream.getTracks().forEach(function(e){i.addTrack(e,o.localStream)}),i.onremovestream=e=>{o.removeStream(i,t,e)},o.rtcConns[t]=i,i},getOrCreateRtcConnect:function(e){let t=this.getRtcConnect(e);return void 0===t&&(t=this.createRtcConnect(e)),t},gotStream:function(e){this.$refs["self-video"].srcObject=e,this.localStream=e},addStream:function(e,t,o){try{null==this.remoteVideoMap[t]&&(this.remoteVideoList.push({id:t,srcObject:o.streams}),this.remoteVideoMap[t]=this.remoteVideoList.length-1),null!=this.$refs[t]&&(this.$refs[t][0].srcObject=o.streams)}catch(e){console.error("addStream error : ",e)}},trackStream:function(e,t,o){try{null==this.remoteVideoMap[t]&&(this.remoteVideoList.push({id:t,srcObject:o.streams[0]}),this.remoteVideoMap[t]=this.remoteVideoList.length-1),null!=this.$refs[t]&&(this.$refs[t][0].srcObject=o.streams[0])}catch(e){console.error("trackStream error : ",e)}},removeStream:function(e,t,o){this.getOrCreateRtcConnect(t).close,delete this.rtcConns[t],delete this.remoteVideoList[this.remoteVideoMap[t]],delete this.remoteVideoMap[t]},iceCandidate:function(e,t,o){null!=o.candidate&&(o={from:this.socketId,to:t,room:this.roomId,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,sdp:o.candidate.candidate},this.socket.emit("candidate",o))},offerSuccess:function(e,t,o){e.setLocalDescription(o).then(e=>{});o={from:this.socketId,to:t,room:this.roomId,sdp:o.sdp};this.socket.emit("offer",o)},offerFailed:function(e,t,o){},answerSuccess:function(e,t,o){e.setLocalDescription(o).then(e=>{});o={from:this.socketId,to:t,room:this.roomId,sdp:o.sdp};this.socket.emit("answer",o)},answerFailed:function(e,t,o){},addIceCandidateSuccess:function(e){},addIceCandidateFailed:function(e){},startCameraSuccess:function(e){this.gotStream(e)},startCameraFailed:function(e){console.log("启动摄像头失败",e),this.createDisabled=!1},startCamera:function(){let t=this;null==this.localStream&&navigator.mediaDevices.getUserMedia(this.userMediaConfig).then(e=>{t.startCameraSuccess(e)}).catch(e=>{t.startCameraFailed(e)})},socketListener:function(){let r=this;this.socket.on("created",async function(i){console.log("created: "+JSON.stringify(i)),r.socketId=i.id,r.roomId=i.room,r.recoderId=i.recoderId;for(let e=0;e<i.peers.length;e++){let t=i.peers[e].id,o=r.getOrCreateRtcConnect(t);o.createOffer(r.options).then(e=>{r.offerSuccess(o,t,e)},e=>{r.offerFailed(o,t,e)})}}),this.socket.on("joined",function(e){console.log("joined: "+JSON.stringify(e)),r.getOrCreateRtcConnect(e.from)}),this.socket.on("offer",function(t){let o=r.getOrCreateRtcConnect(t.from);var e={type:"offer",sdp:t.sdp};o.setRemoteDescription(new RTCSessionDescription(e)).then(e=>{}),o.createAnswer(r.options).then(e=>{r.answerSuccess(o,t.from,e)}).catch(e=>{r.answerFailed(o,t.from,e)})}),this.socket.on("answer",function(e){let t=r.getOrCreateRtcConnect(e.from);e={type:"answer",sdp:e.sdp};t.setRemoteDescription(new RTCSessionDescription(e)).then(e=>{})}),this.socket.on("candidate",function(e){let t=r.getOrCreateRtcConnect(e.from);e=new RTCIceCandidate({candidate:e.sdp,sdpMid:e.sdpMid,sdpMLineIndex:e.sdpMLineIndex});t.addIceCandidate(e).then(e=>{r.addIceCandidateSuccess(e)}).catch(e=>{r.addIceCandidateFailed(e)})}),this.socket.on("exit",function(e){console.log("exit: "+JSON.stringify(e)),void 0===r.rtcConns[e.from]||(r.getOrCreateRtcConnect(e.from).close,delete r.rtcConns[e.from],Vue.delete(r.remoteVideoList,r.remoteVideoMap[e.from]),r.remoteVideoMap[e.from])})},canvasHandler:function(){var e=this.$refs["self-video"];let t=this.$refs["self-canvas"];t.width=230,t.height=200,t.className=this.expand.cssFilter.cssFilterChoose,t.getContext("2d").drawImage(e,0,0,t.width,t.height)},videoTapeHandler:async function(){let t=this.expand.videoTape;if("停止录像"===t.videoText)return t.mediaRecorder.stop(),this.$refs["self-video-tape"].disabled=!0,this.$refs["self-video-play"].disabled=!1,void(this.$refs["self-video-download"].disabled=!1);t.recordedBlobs=[];let o={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(o.mimeType)||(t.errorMsg=`${o.mimeType} is not Supported`,o={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(o.mimeType)||(t.errorMsg=`${o.mimeType} is not Supported`,o={mimeType:"video/webm"},MediaRecorder.isTypeSupported(o.mimeType)||(t.errorMsg=`${o.mimeType} is not Supported`,o={mimeType:""})));try{t.mediaRecorder=new MediaRecorder(this.localStream,o)}catch(e){return void(t.errorMsg=`Exception while creating MediaRecorder: ${JSON.stringify(e)} ${JSON.stringify(o)}`)}console.log("Created MediaRecorder",t.mediaRecorder,"with options",o),t.videoText="停止录像",this.$refs["self-video-play"].disabled=!0,this.$refs["self-video-download"].disabled=!0,t.mediaRecorder.onstop=e=>{},t.mediaRecorder.ondataavailable=e=>{e.data&&0<e.data.size&&t.recordedBlobs.push(e.data)},t.mediaRecorder.start(10),console.log("MediaRecorder started",t.mediaRecorder)},videoPlayHandler:function(){var e=this.expand.videoTape,e=new Blob(e.recordedBlobs,{type:"video/webm"});let t=this.$refs["self-video-tape-video"];t.src=null,t.srcObject=null,t.src=window.URL.createObjectURL(e),t.controls=!0,t.play()},videoDownLoadHandler:function(){var e=this.expand.videoTape,e=new Blob(e.recordedBlobs,{type:"video/webm"});const t=window.URL.createObjectURL(e),o=document.createElement("a");o.style.display="none",o.href=t,o.download="test.webm",document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),window.URL.revokeObjectURL(t)},100)},caculateBindWidth:function(){let i=this;setInterval(()=>{for(var t in i.rtcConns){let e=this.rtcConns[t];e.getStats(null).then(e=>{e.forEach(e=>{var t=e.timestamp;let o=0;"inbound-rtp"===e.type&&"video"===e.mediaType&&(e=e.bytesReceived,i.expand.bindwidth.timestampPrev&&(o=8*(e-i.expand.bindwidth.bytesPrev)/(t-i.expand.bindwidth.timestampPrev),o=Math.floor(o)),i.expand.bindwidth.bytesPrev=e,i.expand.bindwidth.timestampPrev=t,o&&(i.expand.bindwidth.bitrate=o/2))})},e=>console.log(e))}},2e3)},reCaculateSwiperSize:function(){var e=document.body.clientWidth;let t=parseInt(e/100)-2;5<=t&&(t=5),Object.keys(this.remoteVideoMap).length<=3&&(t=3),window.swiper.params.slidesPerView=t},touchResize:function(){let t=this;setTimeout(()=>{var e=new Event("resize");window.dispatchEvent(e),t.reCaculateSwiperSize()},100)}},created:function(){},mounted:function(){this.startCamera(),this.socketListener(),window.onresize=this.reCaculateSwiperSize},destroyed:function(){}})})}},r.c=i,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(o,i,function(e){return t[e]}.bind(null,i));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s="../../res/js/index.js");function r(e){if(i[e])return i[e].exports;var t=i[e]={i:e,l:!1,exports:{}};return o[e].call(t.exports,t,t.exports,r),t.l=!0,t.exports}var o,i});