!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i,o=t();for(i in o)("object"==typeof exports?exports:e)[i]=o[i]}}(this,function(){return o={},r.m=i={"../../res/js/index.js":
/*!***********************************************!*\
  !*** D:/project/tl-rtc-video/res/js/index.js ***!
  \***********************************************/
/*! no static exports found */function(e,t){axios.get("/api/comm/initData",{}).then(e=>{let t=e.data;function o(e,t){window.swiperOther&&window.swiperOther.destroy(!0,!0);t=new Swiper(".swiperOther",{direction:e,loop:!1,slidesPerView:t,observer:!0});window.swiperOther=t}function i(e,t){window.swiperComment&&window.swiperComment.destroy(!0,!0);t=new Swiper(".swiperComment",{direction:e,loop:!1,slidesPerView:t,observer:!0});window.swiperComment=t}setTimeout(()=>{var e=document.body.clientWidth;let t=parseInt(e/100)-2;5<=t&&(t=5),o(700<=e?"vertical":"horizontal",t)}),setTimeout(()=>{var e=document.body.clientWidth;let t=parseInt(e/100)-2;5<=t&&(t=5),o(700<=e?"vertical":"horizontal",t)},500),setTimeout(()=>{i("vertical",5)},100),setTimeout(()=>{i("vertical",5)},600),new Vue({el:"#liveApp",data:function(){let e=null;return io&&(e=io(t.wsHost)),{socket:e,socketId:0,config:t.rtcConfig,options:t.options,userMediaConfig:{audio:{echoCancellation:!0},video:!0},expand:{bindwidth:{timestampPrev:0,bytesPrev:0,bitrate:0},cssFilter:{cssFilterChoose:"none",cssFilterList:[{name:"无",value:"none"},{name:"模糊",value:"blur"},{name:"灰色",value:"grayscale"},{name:"反色",value:"invert"},{name:"棕褐色",value:"sepia"}]},videoTape:{errorMsg:"",videoText:"开始录像",recordedBlobs:[],mediaRecorder:new Object,sourceBuffer:new Object,mediaSource:new MediaSource}},createDisabled:!1,exitDisabled:!0,createClass:"layui-btn layui-btn-normal layui-btn-radius",exitClass:"layui-btn layui-btn-danger layui-btn-radius",disableClass:" layui-btn-disabled",showTools:0,selfVideoStyle:"width:80%;margin-left:10%",messageSendTo:"",messageContent:"",roomId:10086,recoderId:0,rtcConns:{},remoteVideoList:[],remoteVideoMap:{},localStream:null,msgList:[]}},methods:{createRoom:function(){this.roomId&&(this.socket.emit("createAndJoin",{room:this.roomId}),this.createDisabled=!0,this.exitDisabled=!1),this.remoteVideoList.push({id:this.roomId,name:"自己"})},exitRoom:function(){for(var t in this.roomId&&this.socket.emit("exit",{from:this.socketId,room:this.roomId,recoderId:this.recoderId}),this.rtcConns){let e=this.rtcConns[t];e.close(),e=null}this.resetData()},resetData:function(){this.createDisabled=!1,this.exitDisabled=!0,this.createClass="layui-btn layui-btn-normal layui-btn-radius",this.exitClass="layui-btn layui-btn-danger layui-btn-radius",this.disableClass=" layui-btn-disabled",this.showTools=0,this.roomId=1,this.recoderId=0,this.rtcConns={},this.remoteVideoList=[],this.remoteVideoMap={},this.localStream=null},getRtcConnect:function(e){return this.rtcConns[e]},createRtcConnect:function(t){let i=this,o=new RTCPeerConnection(this.config);return o.onicecandidate=e=>{i.iceCandidate(o,t,e)},o.ontrack=e=>{i.trackStream(o,t,e)},null!=i.localStream&&i.localStream.getTracks().forEach(function(e){o.addTrack(e,i.localStream)}),o.onremovestream=e=>{i.removeStream(o,t,e)},i.rtcConns[t]=o,o},getOrCreateRtcConnect:function(e){let t=this.getRtcConnect(e);return void 0===t&&(t=this.createRtcConnect(e)),t},gotStream:function(e){this.$refs["self-video"].srcObject=e,this.localStream=e,this.remoteVideoList.push({id:this.roomId,name:"房主"}),this.$refs[this.roomId].srcObject=e},addStream:function(e,t,i){try{null==this.remoteVideoMap[t]&&(this.remoteVideoList.push({id:t,srcObject:i.streams}),this.remoteVideoMap[t]=this.remoteVideoList.length-1),null!=this.$refs[t]&&(this.$refs[t][0].srcObject=i.streams)}catch(e){console.error("addStream error : ",e)}},trackStream:function(e,t,i){try{null==this.remoteVideoMap[t]&&(this.remoteVideoList.push({id:t,srcObject:i.streams[0]}),this.remoteVideoMap[t]=this.remoteVideoList.length-1),null!=this.$refs[t]&&(this.$refs[t][0].srcObject=i.streams[0])}catch(e){console.error("trackStream error : ",e)}},removeStream:function(e,t,i){this.getOrCreateRtcConnect(t).close,delete this.rtcConns[t],delete this.remoteVideoList[this.remoteVideoMap[t]],delete this.remoteVideoMap[t]},iceCandidate:function(e,t,i){null!=i.candidate&&(i={from:this.socketId,to:t,room:this.roomId,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex,sdp:i.candidate.candidate},this.socket.emit("candidate",i))},offerSuccess:function(e,t,i){e.setLocalDescription(i).then(e=>{});i={from:this.socketId,to:t,room:this.roomId,sdp:i.sdp};this.socket.emit("offer",i)},offerFailed:function(e,t,i){},answerSuccess:function(e,t,i){e.setLocalDescription(i).then(e=>{});i={from:this.socketId,to:t,room:this.roomId,sdp:i.sdp};this.socket.emit("answer",i)},answerFailed:function(e,t,i){},addIceCandidateSuccess:function(e){},addIceCandidateFailed:function(e){},startCameraSuccess:function(e){this.gotStream(e)},startCameraFailed:function(e){console.log("启动摄像头失败",e),this.createDisabled=!1},startCamera:function(){let t=this;null==this.localStream&&navigator.mediaDevices.getUserMedia(this.userMediaConfig).then(e=>{t.startCameraSuccess(e)}).catch(e=>{t.startCameraFailed(e)})},socketListener:function(){let r=this;this.socket.on("created",async function(o){r.touchResize(),console.log("created: "+JSON.stringify(o)),r.socketId=o.id,r.roomId=o.room,r.recoderId=o.recoderId;for(let e=0;e<o.peers.length;e++){let t=o.peers[e].id,i=r.getOrCreateRtcConnect(t);i.createOffer(r.options).then(e=>{r.offerSuccess(i,t,e)},e=>{r.offerFailed(i,t,e)})}}),this.socket.on("joined",function(e){r.touchResize(),console.log("joined: "+JSON.stringify(e)),r.getOrCreateRtcConnect(e.from)}),this.socket.on("offer",function(t){let i=r.getOrCreateRtcConnect(t.from);var e={type:"offer",sdp:t.sdp};i.setRemoteDescription(new RTCSessionDescription(e)).then(e=>{}),i.createAnswer(r.options).then(e=>{r.answerSuccess(i,t.from,e)}).catch(e=>{r.answerFailed(i,t.from,e)})}),this.socket.on("answer",function(e){let t=r.getOrCreateRtcConnect(e.from);e={type:"answer",sdp:e.sdp};t.setRemoteDescription(new RTCSessionDescription(e)).then(e=>{})}),this.socket.on("candidate",function(e){let t=r.getOrCreateRtcConnect(e.from);e=new RTCIceCandidate({candidate:e.sdp,sdpMid:e.sdpMid,sdpMLineIndex:e.sdpMLineIndex});t.addIceCandidate(e).then(e=>{r.addIceCandidateSuccess(e)}).catch(e=>{r.addIceCandidateFailed(e)})}),this.socket.on("exit",function(e){r.touchResize(),console.log("exit: "+JSON.stringify(e)),void 0===r.rtcConns[e.from]||(r.getOrCreateRtcConnect(e.from).close,delete r.rtcConns[e.from],Vue.delete(r.remoteVideoList,r.remoteVideoMap[e.from]),r.remoteVideoMap[e.from])})},canvasHandler:function(){var e=this.$refs["self-video"];let t=this.$refs["self-canvas"];t.width=230,t.height=200,t.className=this.expand.cssFilter.cssFilterChoose,t.getContext("2d").drawImage(e,0,0,t.width,t.height)},videoTapeHandler:async function(){let t=this.expand.videoTape;if("停止录像"===t.videoText)return t.mediaRecorder.stop(),this.$refs["self-video-tape"].disabled=!0,this.$refs["self-video-play"].disabled=!1,void(this.$refs["self-video-download"].disabled=!1);t.recordedBlobs=[];let i={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(i.mimeType)||(t.errorMsg=`${i.mimeType} is not Supported`,i={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(i.mimeType)||(t.errorMsg=`${i.mimeType} is not Supported`,i={mimeType:"video/webm"},MediaRecorder.isTypeSupported(i.mimeType)||(t.errorMsg=`${i.mimeType} is not Supported`,i={mimeType:""})));try{t.mediaRecorder=new MediaRecorder(this.localStream,i)}catch(e){return void(t.errorMsg=`Exception while creating MediaRecorder: ${JSON.stringify(e)} ${JSON.stringify(i)}`)}console.log("Created MediaRecorder",t.mediaRecorder,"with options",i),t.videoText="停止录像",this.$refs["self-video-play"].disabled=!0,this.$refs["self-video-download"].disabled=!0,t.mediaRecorder.onstop=e=>{},t.mediaRecorder.ondataavailable=e=>{e.data&&0<e.data.size&&t.recordedBlobs.push(e.data)},t.mediaRecorder.start(10),console.log("MediaRecorder started",t.mediaRecorder)},videoPlayHandler:function(){var e=this.expand.videoTape,e=new Blob(e.recordedBlobs,{type:"video/webm"});let t=this.$refs["self-video-tape-video"];t.src=null,t.srcObject=null,t.src=window.URL.createObjectURL(e),t.controls=!0,t.play()},videoDownLoadHandler:function(){var e=this.expand.videoTape,e=new Blob(e.recordedBlobs,{type:"video/webm"});const t=window.URL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=t,i.download="test.webm",document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),window.URL.revokeObjectURL(t)},100)},caculateBindWidth:function(){let o=this;setInterval(()=>{for(var t in o.rtcConns){let e=this.rtcConns[t];e.getStats(null).then(e=>{e.forEach(e=>{var t=e.timestamp;let i=0;"inbound-rtp"===e.type&&"video"===e.mediaType&&(e=e.bytesReceived,o.expand.bindwidth.timestampPrev&&(i=8*(e-o.expand.bindwidth.bytesPrev)/(t-o.expand.bindwidth.timestampPrev),i=Math.floor(i)),o.expand.bindwidth.bytesPrev=e,o.expand.bindwidth.timestampPrev=t,i&&(o.expand.bindwidth.bitrate=i/2))})},e=>console.log(e))}},2e3)},reCaculateSwiperSize:function(){var e=document.body.clientWidth;let t=parseInt(e/100);5<=t&&(t=5),o(700<=e?"vertical":"horizontal",t);let i=80-5*parseInt((e-700)/100);i<=40&&(i=40),70<=i&&(i=70),e<700?(this.selfVideoStyle="width:80%;",this.selfVideoStyle+="margin-left:10%"):(this.selfVideoStyle=`width:${i}%;`,40===i&&(this.selfVideoStyle+="margin-left:10%"),1500<e&&(this.selfVideoStyle=`width:${i}%;`))},touchResize:function(){let t=this;setTimeout(()=>{var e=new Event("resize");window.dispatchEvent(e),t.reCaculateSwiperSize()},100)}},created:function(){},mounted:function(){this.startCamera(),this.socketListener(),window.onresize=this.reCaculateSwiperSize,this.reCaculateSwiperSize()},destroyed:function(){}})})}},r.c=o,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(i,o,function(e){return t[e]}.bind(null,o));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s="../../res/js/index.js");function r(e){if(o[e])return o[e].exports;var t=o[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,r),t.l=!0,t.exports}var i,o});